@startuml
title Activity: Выбор парковочного места, времени и слота (Driver + SPA + Parking Service)

|Driver|
start
:Открыть карту парковок;
:Разрешить геолокацию (опционально);
:Выбрать зону/парковку на карте;

|SPA (React)|
:GET /parkings?bbox&filters (через Nginx);

|Parking Service|
:Получить список парковок по области;
:Обогатить данными (адрес/координаты, Google Maps);
:Вернуть парковки + агрегированную доступность;

|SPA (React)|
:Показать парковки на карте;
:Показать краткую доступность/тариф (если есть);

|Driver|
:Открыть карточку парковки;
:Выбрать дату;
:Выбрать время начала;
:Выбрать длительность/время окончания;

|SPA (React)|
:GET /parkings/{id}/slots?date&timeRange;

|Parking Service|
if (Есть слоты в Redis?) then (Да)
  :Прочитать слоты/availability из Redis;
else (Нет)
  :Рассчитать слоты по расписанию/правилам;
  :Проверить занятость по бронированиям в PostgreSQL;
  :Сохранить слоты/availability в Redis;
endif
:Вернуть список слотов + статусы (Free/Held/Busy) + цену;

|SPA (React)|
:Отрисовать сетку слотов (таймлайн);
:Подсветить недоступные интервалы;

|Driver|
:Выбрать конкретный слот (временной интервал);
if (Слот недоступен?) then (Да)
  :Выбрать другой слот/время;
  -> |SPA (React)| :Обновить запрос слотов (при необходимости);
else (Нет)
  :Нажать "Продолжить";
endif

|SPA (React)|
:POST /availability/hold (parkingId, slotId, timeRange);

|Parking Service|
:Попытаться поставить hold на слот (атомарно);
if (Hold успешен?) then (Да)
  :Записать hold в Redis (TTL);
  :Вернуть holdId + expiresAt;
else (Нет)
  :Вернуть конфликт (slot already taken);
endif

|SPA (React)|
if (Hold успешен?) then (Да)
  :Показать подтверждение выбора + таймер hold;
  :Кнопка "Перейти к бронированию";
  |Driver|
  :Подтвердить выбор;
  stop
else (Нет)
  |Driver|
  :Увидеть сообщение "Слот уже занят";
  :Выбрать другой слот;
  -> |SPA (React)| :Запросить слоты заново;
endif
@enduml
