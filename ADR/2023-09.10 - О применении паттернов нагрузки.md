**ADR: 2025-11.8 - Анализ архитектурных паттернов для системы управления парковками**

**Дата:** 19 ноября 2025 г.

**Статус:** Принято

**Контекст:**
Для удовлетворения нефункциональных требований по производительности (PER01-PER04), масштабируемости (SCA01-SCA03), доступности (AVA01) и надежности (DUR01-DUR03) системы управления парковками необходимо проанализировать и применить соответствующие архитектурные паттерны. Каждый паттерн должен быть оценен с точки зрения применимости к конкретным компонентам системы.

**Рассмотренные паттерны:**
1. Трехзвенная структура
2. Кеширование и проблема инвалидации кеша
3. Толстый клиент
4. Деградация функциональности
5. Масштабирование (горизонтальное, вертикальное, во времени)
6. SOA и монолит
7. Индексы в базе данных
8. Репликация
9. Вертикальный и горизонтальный шардинг
10. Партиционирование
11. Денормализация
12. Функциональное разделение
13. Отложенные вычисления
14. Асинхронная обработка
15. Конвейер
16. Параллельные выполнения
17. Comet-сервера

**Решение:**
Применение комбинации паттернов в различных компонентах системы:
- **Поиск и отображение парковок:** Кеширование + индексы + денормализация
- **Бронирование и оплата:** Асинхронная обработка + партиционирование + репликация
- **Аналитика и отчеты:** Отложенные вычисления + горизонтальный шардинг
- **Уведомления:** Comet-сервера + конвейерная обработка
- **Архитектурный стиль:** Функциональное разделение (микросервисы) + горизонтальное масштабирование

**Обоснование:**

### 1. **Трехзвенная структура**
- **Применение:** Базовая архитектура каждого микросервиса.
- **Решаемые требования:** PER01, SCA01, DUR01.
- **Плюсы:** Четкое разделение ответственности, упрощение тестирования, независимость слоев
- **Минусы:** Дополнительные накладные расходы на межслойное взаимодействие
- **Компоненты:** Все сервисы (Presentation Layer → Business Layer → Data Layer)

### 2. **Кеширование и проблема инвалидации кеша**
- **Применение:** Сервис поиска парковок (Redis), кеширование геоданных и тарифов
- **Решаемые требования:** PER02, SCA01
- **Плюсы:** Ускорение ответов в 10-100 раз, снижение нагрузки на БД
- **Минусы:** Проблема согласованности данных, сложность инвалидации
- **Стратегия инвалидации:** TTL 30 сек + инвалидация по событиям изменения статуса парковки

### 3. **Толстый клиент**
- **Применение:** Не применяется, так как противоречит PRN01 (простота интерфейса)
- **Решаемые требования:** (не применяется)
- **Плюсы:** (не применимо)
- **Минусы:** Усложнение клиента, проблемы с обновлениями, зависимость от качества сети

### 4. **Деградация функциональности**
- **Применение:** Сервис бронирования при высокой нагрузке или сбоях платежных систем
- **Решаемые требования:** AVA01, DUR01
- **Плюсы:** Сохранение работоспособности ключевых функций (поиск) при сбоях второстепенных (оплата)
- **Минусы:** Ухудшение пользовательского опыта, необходимость явного уведомления пользователей
- **Сценарий:** При недоступности платежного шлюза - переход на ручное оформление с последующей оплатой

### 5. **Масштабирование**
- **Горизонтальное:** Сервисы поиска и бронирования (добавление инстансов)
- **Вертикальное:** Базы данных аналитики (увеличение ресурсов ноды)
- **Во времени:** Отложенная обработка отчетов в ночное время
- **Решаемые требования:** SCA01, SCA02, SCA03, PER04
- **Плюсы:** Гибкость, отказоустойчивость
- **Минусы:** Сложность управления состоянием при горизонтальном масштабировании

### 6. **SOA и монолит**
- **Применение:** Выбрана SOA (микросервисы) на основе PRN02
- **Решаемые требования:** SCA01, DUR01, AVA01
- **Плюсы SOA:** Независимое масштабирование, технологическая гибкость
- **Минусы SOA:** Сложность распределенных транзакций, overhead на сетевые вызовы

### 7. **Индексы в базе данных**
- **Применение:** PostgreSQL - индексы для поиска парковок по геолокации, времени, статусу
- **Решаемые требования:** PER02, PER03
- **Плюсы:** Ускорение поиска в 100-1000 раз
- **Минусы:** Замедление операций вставки/обновления, дополнительное дисковое пространство
- **Типы индексов:** GiST для геоданных, B-tree для временных диапазонов

### 8. **Репликация**
- **Применение:** Master-Slave репликация PostgreSQL, репликация Kafka
- **Решаемые требования:** AVA01, DUR01, DUR02
- **Плюсы:** Повышение доступности, распределение нагрузки на чтение
- **Минусы:** Задержка репликации, сложность разрешения конфликтов
- **Конфигурация:** 1 мастер + 2 реплики для PostgreSQL, 3 брокера для Kafka

### 9. **Шардинг**
- **Вертикальный:** Разделение таблиц по сервисам (парковки, пользователи, платежи)
- **Горизонтальный:** Шардинг парковок по географическим регионам
- **Решаемые требования:** SCA02, SCA03
- **Плюсы:** Распределение нагрузки, изоляция отказов
- **Минусы:** Сложность кросс-шардовых запросов, миграция данных
- **Ключ шардирования:** Идентификатор города/района

### 10. **Партиционирование**
- **Применение:** Таблицы транзакций по месяцам, логи событий по дням
- **Решаемые требования:** PER04, SCA01
- **Плюсы:** Ускорение запросов к историческим данным, упрощение удаления устаревших данных
- **Минусы:** Сложность запросов по нескольким партициям
- **Стратегия:** Range partitioning по дате

### 11. **Денормализация**
- **Применение:** Таблица парковок с включенными часто запрашиваемыми данными (тариф, количество мест)
- **Решаемые требования:** PER02, PER03
- **Плюсы:** Уменьшение количества JOIN, ускорение запросов
- **Минусы:** Избыточность данных, сложность обновлений
- **Пример:** Хранение текущего тарифа в таблице парковки вместе с основной информацией

### 12. **Функциональное разделение**
- **Применение:** Разделение на микросервисы: поиск, бронирование, оплата, уведомления, аналитика
- **Решаемые требования:** SCA01, DUR01, AVA01
- **Плюсы:** Независимость разработки и развертывания
- **Минусы:** Сложность управления распределенной системой
- **Разделение:** По bounded context (парковки, пользователи, платежи)

### 13. **Отложенные вычисления**
- **Применение:** Генерация ежедневных отчетов, расчет статистики
- **Решаемые требования:** PER04, SCA01
- **Плюсы:** Снижение пиковой нагрузки, лучшее использование ресурсов
- **Минусы:** Неактуальность данных в реальном времени
- **Пример:** Ночной расчет агрегированной статистики за день

### 14. **Асинхронная обработка**
- **Применение:** Отправка уведомлений, обработка платежей, обновление статусов
- **Решаемые требования:** PER01, PER03, SCA01
- **Плюсы:** Неблокирующая обработка, отказоустойчивость
- **Минусы:** Сложность отслеживания статуса операций
- **Реализация:** Kafka + асинхронные обработчики

### 15. **Конвейер**
- **Применение:** Обработка потока событий с датчиков парковок
- **Решаемые требования:** PER02, SCA01
- **Плюсы:** Параллельная обработка, балансировка нагрузки
- **Минусы:** Сложность управления зависимостями между стадиями
- **Этапы:** Валидация → обогащение → сохранение → уведомление

### 16. **Параллельные выполнения**
- **Применение:** Параллельная обработка запросов поиска по разким регионам
- **Решаемые требования:** PER02, SCA01
- **Плюсы:** Ускорение обработки за счет использования нескольких ядер
- **Минусы:** Сложность синхронизации, contention ресурсов
- **Реализация:** Goroutines в Go-сервисах

### 17. **Comet-сервера**
- **Применение:** Сервис уведомлений в реальном времени об изменении статуса парковки
- **Решаемые требования:** PER01, F03
- **Плюсы:** Мгновенная доставка уведомлений, снижение нагрузки от polling
- **Минусы:** Высокое потребление ресурсов при многих подключениях
- **Технология:** WebSockets для мобильных клиентов, Server-Sent Events для веба

**Последствия:**

1. **Технические:**
   - Необходимо внедрить комплексную систему мониторинга производительности паттернов
   - Требуется разработка механизмов инвалидации кеша на основе событий
   - Важно обеспечить баланс между денормализацией и согласованностью данных

2. **Операционные:**
   - Сложность эксплуатации распределенной системы с множеством паттернов
   - Необходимость автоматизации развертывания и масштабирования
   - Требуется мониторинг задержек репликации и согласованности данных

3. **Бизнес-последствия:**
   - Повышение удовлетворенности пользователей за счет отзывчивости системы
   - Снижение рисков простоя благодаря отказоустойчивой архитектуре
   - Возможность плавного роста системы с увеличением числа пользователей

**Рекомендации по реализации:**
1. Начать с критических паттернов: кеширование, индексы, асинхронная обработка
2. Постепенно внедрять шардинг и партиционирование по мере роста данных
3. Мониторить эффективность каждого паттерна и корректировать подход
4. Документировать принятые решения по каждому паттерну для команды разработки