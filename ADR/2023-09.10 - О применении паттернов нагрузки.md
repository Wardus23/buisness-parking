**ADR: 2025-11.8 - Анализ паттернов нагрузки и выбор стратегии масштабирования**

**Дата:** 19 ноября 2025 г.

**Статус:** Принято

**Контекст:**
Система Парковки должна работать стабильно при различных паттернах нагрузки, характерных для городской среды. Необходимо проанализировать типичные паттерны нагрузки и определить архитектурные стратегии для удовлетворения нефункциональных требований по производительности (PER01-PER04), масштабируемости (SCA01-SCA03) и доступности (AVA01).

**Анализ паттернов нагрузки:**

### 1. **Суточные колебания (Diurnal Pattern)**
**Описание:** Циклические изменения нагрузки в течение суток с пиками в утренние (8:00-10:00) и вечерние (17:00-19:00) часы.
- **Влияние на систему:** Максимальная нагрузка на сервисы поиска парковок и бронирования
- **Соответствующие требования:** PER02, PER03, SCA01
- **Стратегия:** Автоматическое горизонтальное масштабирование с прогнозным увеличением мощности за 30 минут до пиков
- **Плюсы:** Экономия ресурсов в ночное время, предсказуемость
- **Минусы:** Требуется анализ исторических данных для точного прогнозирования

### 2. **Пиковая нагрузка (Peak Load)**
**Описание:** Кратковременные экстремальные нагрузки во время специальных событий (концерты, футбольные матчи, праздники)
- **Влияние на систему:** Резкий рост запросов к API карт и бронированию
- **Соответствующие требования:** PER01, PER02, SCA02, SCA03
- **Стратегия:** Автоматическое масштабирование по метрикам (CPU > 70%, RPS > 1000), кэширование геоданных
- **Плюсы:** Автоматическая реакция на неожиданные нагрузки
- **Минусы:** Задержка в развертывании новых инстансов (2-3 минуты)

### 3. **Периодические всплески (Periodic Bursts)**
**Описание:** Регулярные короткие всплески каждые 15-30 минут при синхронизации с датчиками парковок
- **Влияние на систему:** Нагрузка на сервис обновления статуса парковочных мест и Kafka
- **Соответствующие требования:** PER01, PER02, SCA01
- **Стратегия:** Очереди сообщений (Kafka) для буферизации, асинхронная обработка
- **Плюсы:** Сглаживание нагрузки, отказоустойчивость
- **Минусы:** Сложность обеспечения консистентности данных в реальном времени

### 4. **Сезонные колебания (Seasonal Pattern)**
**Описание:** Изменения нагрузки в зависимости от сезона (летом больше туристов, зимой меньше)
- **Влияние на систему:** Постепенное изменение базовой нагрузки
- **Соответствующие требования:** SCA02, SCA03
- **Стратегия:** Плановое масштабирование инфраструктуры раз в квартал
- **Плюсы:** Оптимизация затрат, планирование бюджета
- **Минусы:** Медленная реакция на неожиданные сезонные изменения

### 5. **Непредсказуемые всплески (Unpredictable Bursts)**
**Описание:** Внезапные нагрузки из-за внешних событий (аварии, закрытие крупных парковок, погодные условия)
- **Влияние на систему:** Резкий рост запросов поиска альтернативных парковок
- **Соответствующие требования:** PER02, SCA01, AVA01
- **Стратегия:** Горячее резервирование (10% дополнительной мощности), Circuit Breaker для защиты зависимостей
- **Плюсы:** Высокая доступность в критических ситуациях
- **Минусы:** Постоянные затраты на резервные ресурсы

### 6. **Постепенное увеличение (Gradual Increase)**
**Описание:** Медленный рост нагрузки по мере добавления новых парковок и пользователей
- **Влияние на систему:** Постепенное увеличение нагрузки на все компоненты
- **Соответствующие требования:** SCA02, SCA03
- **Стратегия:** Регулярный мониторинг трендов, плановое увеличение мощности на 20% каждые 6 месяцев
- **Плюсы:** Планируемые затраты, отсутствие сюрпризов
- **Минусы:** Риск недооценки скорости роста

### 7. **Прогрессивная нагрузка (Progressive Load)**
**Описание:** Постепенное увеличение нагрузки во время длительных операций (генерация отчетов, массовые уведомления)
- **Влияние на систему:** Нагрузка на сервис аналитики и уведомлений
- **Соответствующие требования:** PER04, SCA01
- **Стратегия:** Выделенные worker-ноды для фоновых задач, приоритизация запросов
- **Плюсы:** Изоляция фоновых задач от пользовательских операций
- **Минусы:** Сложность балансировки ресурсов

**Решение:**
Принята многоуровневая стратегия управления нагрузкой:

1. **Для суточных колебаний:** Прогнозный автоскейлинг на основе машинного обучения исторических данных
2. **Для пиковых нагрузок:** Реактивное горизонтальное масштабирование с кэшированием в Redis
3. **Для периодических всплесков:** Буферизация в Kafka с batch-обработкой
4. **Для непредсказуемых событий:** Горячее резервирование 15% мощности + Circuit Breaker
5. **Для прогрессивной нагрузки:** Выделенный пул worker-нодов для фоновых задач

**Архитектурные реализации:**
- Сервис поиска парковок: Автоскейлинг от 5 до 50 инстансов
- Сервис обновления статусов: Очередь Kafka + фиксированный пул обработчиков
- Сервис аналитики: Выделенные ноды с вертикальным масштабированием
- API Gateway: Rate limiting (1000 RPM на пользователя) + кэширование

**Обоснование:**
Различные компоненты системы испытывают разные паттерны нагрузки:
- Пользовательский интерфейс подвержен суточным и пиковым нагрузкам
- Интеграция с датчиками создает периодические всплески
- Фоновая аналитика требует прогрессивной обработки

Многоуровневая стратегия позволяет оптимизировать затраты при сохранении производительности.

**Последствия:**
- Требуется внедрение сложной системы мониторинга с прогнозированием
- Необходимо настроить различные политики автоскейлинга для разных сервисов
- Следует реализовать механизмы graceful degradation при экстремальных нагрузках
- Требуется регулярный анализ паттернов нагрузки и корректировка стратегий
- Необходимо обеспечить баланс между производительностью и стоимостью инфраструктуры